name: Build and Release

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  # ==================== macOS æ„å»º ====================
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        mode: [desktop, browser]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install pyinstaller
        pip install flask flask-cors pywebview
        pip install openai python-dotenv requests
        pip install pymupdf python-docx openpyxl pillow
    
    - name: Create .env file
      run: |
        echo "DEEPSEEK_API_KEY=" > .env
        echo "DEEPSEEK_BASE_URL=https://api.deepseek.com" >> .env
        echo "AI_MODEL=deepseek-chat" >> .env
        echo "AI_TIMEOUT=150" >> .env
    
    - name: Build Desktop (windowed)
      if: matrix.mode == 'desktop'
      run: |
        pyinstaller --name="Cyber Resume Parser" \
          --windowed \
          --icon=icon.jpg \
          --add-data="static:static" \
          --add-data="Templates:Templates" \
          --add-data=".env:." \
          desktop_app.py
    
    - name: Build Browser (console)
      if: matrix.mode == 'browser'
      run: |
        pyinstaller --name="Cyber Resume Parser Browser" \
          --console \
          --icon=icon.jpg \
          --add-data="static:static" \
          --add-data="Templates:Templates" \
          --add-data=".env:." \
          desktop_app.py
    
    - name: Create ZIP
      run: |
        cd dist
        zip -r ../Mac-${{ matrix.mode }}.zip .
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Mac-${{ matrix.mode }}
        path: Mac-${{ matrix.mode }}.zip

  # ==================== Windows æ„å»º ====================
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        mode: [desktop, browser]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install pyinstaller
        pip install flask flask-cors pywebview
        pip install openai python-dotenv requests
        pip install pymupdf python-docx openpyxl pillow
    
    - name: Create .env file
      run: |
        echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" > .env
        echo "DEEPSEEK_BASE_URL=https://api.deepseek.com" >> .env
        echo "AI_MODEL=deepseek-chat" >> .env
        echo "AI_TIMEOUT=150" >> .env
    
    - name: Build Desktop (windowed)
      if: matrix.mode == 'desktop'
      run: |
        pyinstaller --name="Cyber Resume Parser" `
          --windowed `
          --icon=icon.jpg `
          --add-data="static;static" `
          --add-data="Templates;Templates" `
          --add-data=".env;." `
          --hidden-import=flask `
          --hidden-import=flask_cors `
          --hidden-import=jinja2 `
          --hidden-import=werkzeug `
          --hidden-import=webview `
          --hidden-import=webview.platforms.mshtml `
          desktop_app.py
    
    - name: Build Browser (console)
      if: matrix.mode == 'browser'
      run: |
        pyinstaller --name="Cyber Resume Parser Browser" `
          --console `
          --icon=icon.jpg `
          --add-data="static;static" `
          --add-data="Templates;Templates" `
          --add-data=".env;." `
          desktop_app.py
    
    - name: Create ZIP
      run: |
        cd dist
        Compress-Archive -Path * -DestinationPath ../Windows-${{ matrix.mode }}.zip
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Windows-${{ matrix.mode }}
        path: Windows-${{ matrix.mode }}.zip

  # ==================== å‘å¸ƒåˆ° Releases ====================
  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/Mac-desktop/Mac-desktop.zip
          artifacts/Mac-browser/Mac-browser.zip
          artifacts/Windows-desktop/Windows-desktop.zip
          artifacts/Windows-browser/Windows-browser.zip
        body: |
          ## ğŸ“¦ ä¸‹è½½
          
          | å¹³å° | Desktop ç‰ˆ | Browser ç‰ˆ |
          |------|-----------|------------|
          | macOS | Mac-desktop.zip | Mac-browser.zip |
          | Windows | Windows-desktop.zip | Windows-browser.zip |
          
          **Desktop ç‰ˆ**: åŒå‡»ç›´æ¥è¿è¡Œï¼Œç‹¬ç«‹çª—å£
          **Browser ç‰ˆ**: å‘½ä»¤è¡Œå¯åŠ¨ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
